name: ci
run-name: CarpetX tests
on: [push]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install packages
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get --no-install-recommends --yes install \
              build-essential \
              ca-certificates \
              g++ \
              gfortran \
              git \
              hdf5-tools \
              libboost-all-dev \
              libfftw3-dev \
              libgit2-dev \
              libgsl-dev \
              libhdf5-dev \
              libhwloc-dev \
              libopenblas-dev \
              libopenmpi-dev \
              libpetsc-real-dev \
              libudev-dev \
              perl \
              pkg-config \
              python2 \
              python3 \
              python3-pip \
              python3-requests \
              rsync \
              subversion \
              wget \
              zlib1g-dev
      - name: Prepare /usr/local
        run: |
          ls -lda /usr/local
          ls -la /usr/local
          ls -lR /usr/local
          sudo chmod -R a+rwx /usr/local
          ls -lda /usr/local
          ls -la /usr/local
          ls -lR /usr/local
      - name: Restore dependencies
        uses: actions/cache@v3
        id: cache-dependencies
        with:
          # Note: Change this key if the dependencies change, e.g. if we install newer versions
          # Update the respective file name in `install_dependencies.sh` as well
          key: dependencies-2
          path: |
            /usr/local
      - name: Install dependencies
        if: ${{steps.cache-dependencies.npm.outputs.cache-hit != 'true'}}
        run: |
          .github/workflows/install_dependencies.sh
      - name: Download Cactus
        run: |
          # Working directory starts out as
          # `/home/runner/work/CarpetX/CarpetX`, inside the CarpetX
          # repo
          cd ..
          # Download the Cactus installer
          wget https://raw.githubusercontent.com/gridaphobe/CRL/ET_2022_11/GetComponents
          chmod a+x GetComponents
          # Download Cactus thorns
          ./GetComponents --parallel https://bitbucket.org/einsteintoolkit/manifest/raw/ET_2022_11/einsteintoolkit.th
          # Create a link to the CarpetX repository
          ln -s ../../CarpetX Cactus/repos
      - name: Build Cactus
        run: |
          # Set up the runner
          cd ../Cactus
          cp repos/CarpetX/.github/workflows/actions.ini ./simfactory/mdb/machines
          cp repos/CarpetX/.github/workflows/actions.cfg ./simfactory/mdb/options
          cp repos/CarpetX/.github/workflows/actions.th .
          ./simfactory/bin/sim --machine=actions build sim --thornlist=actions.th
      # - name: Run Cactus tests
